---
- name: Get the LoadBalander ip address or Openshift Router ip address
  when: not microshift_frontend_address
  block:
    - name: Create script to get ingress ip address
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          IP=$(oc get svc -n openshift-ingress router-internal-default -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "${IP}" ]; then
              IP=$(oc get svc -n openshift-ingress router-internal-default -o jsonpath='{.spec.clusterIP}');
          fi
          echo "${IP}"
        dest: /tmp/recognize_ingress_ip.sh
        mode: 0755

    - name: Get Ingress IP Address
      ansible.builtin.command: /tmp/recognize_ingress_ip.sh
      register: _lb_ip

    - name: Set the LB or Router IP address as default address for FQDN
      ansible.builtin.set_fact:
        microshift_frontend_address: "{{ _lb_ip.stdout }}"

# NOTE: Add Openstack k8s domains
- name: Add new addresses to bind to the ingress
  become: true
  ansible.builtin.lineinfile:
    path: /etc/dnsmasq.conf
    line: "address=/{{ item }}/{{ microshift_frontend_address }}"
  loop: "{{ microshift_additional_addresses }}"
  when: microshift_frontend_address
  notify: Restart DNSMasq service
